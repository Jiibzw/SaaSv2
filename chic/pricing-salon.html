<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Offres & Tarifs - Salon Chic</title>
    <script src="https://js.stripe.com/v3/"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #c9184a;
            --primary-light: #c9184a15;
            --primary-hover: #c9184add;
            --bg: #f8fafc;
            --surface: #ffffff;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 16px;
            --sidebar-width: 280px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--bg); color: var(--text-main); -webkit-font-smoothing: antialiased; }
        
        /* Layout */
        .dashboard-container { display: flex; min-height: 100vh; }
        
        /* Sidebar */
        .sidebar { width: var(--sidebar-width); background: var(--surface); border-right: 1px solid var(--border); position: fixed; top: 0; bottom: 0; left: 0; z-index: 50; padding: 2rem 1.5rem; display: flex; flex-direction: column; transition: transform 0.3s ease; }
        .brand { display: flex; align-items: center; gap: 1rem; font-size: 1.25rem; font-weight: 700; color: var(--text-main); text-decoration: none; margin-bottom: 3rem; padding: 0 0.5rem; }
        .brand i { color: var(--primary); }
        .nav-menu { flex: 1; display: flex; flex-direction: column; gap: 0.5rem; }
        .nav-item { display: flex; align-items: center; gap: 1rem; padding: 1rem; color: var(--text-muted); text-decoration: none; border-radius: var(--radius); font-weight: 500; transition: all 0.2s; cursor: pointer; }
        .nav-item:hover { background: var(--bg); color: var(--text-main); }
        .nav-item.active { background: var(--primary-light); color: var(--primary); font-weight: 600; }
        .nav-item i { width: 20px; text-align: center; }
        
        .user-profile { margin-top: auto; padding-top: 1.5rem; border-top: 1px solid var(--border); display: flex; align-items: center; gap: 1rem; }
        .avatar { width: 40px; height: 40px; background: var(--primary); color: white; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: 600; }
        .user-info { flex: 1; overflow: hidden; }
        .user-name { font-weight: 600; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .user-role { font-size: 0.8rem; color: var(--text-muted); }
        .btn-logout { background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 0.5rem; border-radius: 8px; transition: all 0.2s; }
        .btn-logout:hover { background: #fee2e2; color: #ef4444; }

        /* Main Content */
        .main-content { flex: 1; margin-left: var(--sidebar-width); padding: 2rem; width: calc(100% - var(--sidebar-width)); }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2.5rem; }
        .page-title { font-size: 1.75rem; font-weight: 700; color: var(--text-main); }
        .date-display { color: var(--text-muted); font-weight: 500; }
        
        /* Pricing Grid */
        .pricing-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem; margin-bottom: 4rem; }
        .pricing-card { background: var(--surface); border-radius: 24px; padding: 2rem; border: 1px solid var(--border); position: relative; transition: transform 0.2s, box-shadow 0.2s; display: flex; flex-direction: column; }
        .pricing-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-md); }
        .pricing-card.featured { border: 2px solid var(--primary); box-shadow: 0 10px 30px -10px var(--primary-light); }
        .pricing-card.premium { background: linear-gradient(145deg, #1e293b, #0f172a); color: white; border: none; }
        
        .plan-badge { position: absolute; top: 1.5rem; right: 1.5rem; padding: 0.35rem 0.85rem; border-radius: 99px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; }
        .badge-current { background: #dcfce7; color: #166534; }
        .badge-popular { background: var(--primary-light); color: var(--primary); }
        .badge-new { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }

        .plan-name { font-size: 1.25rem; font-weight: 700; margin-bottom: 0.5rem; }
        .plan-price { font-size: 2.5rem; font-weight: 800; margin-bottom: 1.5rem; display: flex; align-items: baseline; gap: 0.25rem; }
        .plan-price span { font-size: 1rem; font-weight: 500; color: var(--text-muted); }
        .pricing-card.premium .plan-price span { color: #94a3b8; }
        
        .features-list { list-style: none; margin-bottom: 2rem; flex: 1; }
        .features-list li { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem; font-size: 0.95rem; }
        .features-list li i { color: var(--primary); }
        .pricing-card.premium .features-list li i { color: #4ade80; }
        
        .btn-plan { width: 100%; padding: 1rem; border-radius: 12px; font-weight: 600; cursor: pointer; border: none; transition: all 0.2s; font-size: 1rem; }
        .btn-outline { background: transparent; border: 2px solid var(--border); color: var(--text-main); }
        .btn-outline:hover { border-color: var(--text-main); background: var(--text-main); color: white; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-white { background: white; color: #0f172a; }
        .btn-white:hover { background: #f1f5f9; }
        .btn-disabled { background: #e2e8f0; color: #94a3b8; cursor: not-allowed; }

        /* Comparison Table */
        .comparison-section { background: var(--surface); border-radius: 24px; padding: 2rem; border: 1px solid var(--border); overflow: hidden; }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 1.5rem; background: var(--bg); font-weight: 600; color: var(--text-muted); font-size: 0.9rem; }
        td { padding: 1.5rem; border-bottom: 1px solid var(--border); color: var(--text-main); }
        tr:last-child td { border-bottom: none; }
        .check { color: #10b981; font-size: 1.1rem; }
        .cross { color: #ef4444; font-size: 1.1rem; opacity: 0.5; }
        
        /* Mobile */
        .mobile-toggle { display: none; font-size: 1.5rem; color: var(--text-main); cursor: pointer; background: none; border: none; }
        
        @media (max-width: 1024px) {
            .sidebar { transform: translateX(-100%); box-shadow: 20px 0 40px rgba(0,0,0,0.1); }
            .sidebar.open { transform: translateX(0); }
            .main-content { margin-left: 0; width: 100%; padding: 1.5rem; }
            .mobile-toggle { display: block; }
            .top-bar { gap: 1rem; }
        }
    </style>
</head>
<body>

    <div class="dashboard-container">
        <aside class="sidebar" id="sidebar">
            <a href="#" class="brand"><i class="fa-solid fa-clock"></i> TimeToBook</a>
            <nav class="nav-menu">
                <a href="dashboard-chic.html" class="nav-item"><i class="fa-solid fa-chart-pie"></i> Vue d'ensemble</a>
                <a href="admin.html" class="nav-item"><i class="fa-solid fa-store"></i> Gestion Salon</a>
                <div class="nav-item active"><i class="fa-solid fa-tags"></i> Offres & Tarifs</div>
            </nav>
            <div class="user-profile">
                <div class="avatar">C</div>
                <div class="user-info">
                    <div class="user-name">Salon Chic</div>
                    <div class="user-role">Propriétaire</div>
                </div>
                <a href="../" class="btn-logout" title="Déconnexion"><i class="fa-solid fa-right-from-bracket"></i></a>
            </div>
        </aside>

        <main class="main-content">
            <div class="top-bar">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <button class="mobile-toggle" onclick="toggleSidebar()"><i class="fa-solid fa-bars"></i></button>
                    <div>
                        <h1 class="page-title">Nos Offres</h1>
                        <div class="date-display">Choisissez le plan adapté à votre croissance</div>
                    </div>
                </div>
            </div>

            <div class="pricing-grid">
                <!-- Starter -->
                <div class="pricing-card" id="card-starter">
                    <div class="plan-badge badge-current" style="display: none;">Actuel</div>
                    <div class="plan-name">Starter</div>
                    <div class="plan-price">39€<span>/mois</span></div>
                    <ul class="features-list">
                        <li><i class="fa-solid fa-check"></i> 1 Salon de coiffure</li>
                        <li><i class="fa-solid fa-check"></i> Coiffeurs illimités</li>
                        <li><i class="fa-solid fa-check"></i> Réservations illimitées</li>
                        <li><i class="fa-solid fa-check"></i> Support Email</li>
                    </ul>
                    <button class="btn-plan btn-outline" id="btn-starter" onclick="checkout('starter')">Choisir Starter</button>
                </div>

                <!-- Pro -->
                <div class="pricing-card featured" id="card-pro">
                    <div class="plan-badge badge-popular" id="badge-pro">Populaire</div>
                    <div class="plan-name">Pro</div>
                    <div class="plan-price">69€<span>/mois</span></div>
                    <ul class="features-list">
                        <li><i class="fa-solid fa-check"></i> 2 Salons de coiffure</li>
                        <li><i class="fa-solid fa-check"></i> Tout du plan Starter</li>
                        <li><i class="fa-solid fa-check"></i> Statistiques Avancées</li>
                        <li><i class="fa-solid fa-check"></i> Support Prioritaire</li>
                        <li><i class="fa-solid fa-check"></i> Personnalisation couleurs</li>
                    </ul>
                    <button class="btn-plan btn-primary" id="btn-pro" onclick="checkout('pro')">Passer au Pro</button>
                </div>

                <!-- Premium -->
                <div class="pricing-card premium" id="card-premium">
                    <div class="plan-badge badge-new" id="badge-premium">Nouveau</div>
                    <div class="plan-name">Premium</div>
                    <div class="plan-price">89€<span>/mois</span></div>
                    <ul class="features-list">
                        <li><i class="fa-solid fa-check"></i> 3 Salons ou +</li>
                        <li><i class="fa-solid fa-check"></i> Tout du plan Pro</li>
                        <li><i class="fa-solid fa-check"></i> API Access</li>
                        <li><i class="fa-solid fa-check"></i> Support VIP 24/7</li>
                        <li><i class="fa-solid fa-check"></i> Account Manager dédié</li>
                    </ul>
                    <button class="btn-plan btn-white" id="btn-premium" onclick="checkout('premium')">Choisir Premium</button>
                </div>
            </div>

            <div class="comparison-section">
                <h2 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 1.5rem;">Comparaison détaillée</h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Fonctionnalités</th>
                                <th style="text-align: center;">Starter</th>
                                <th style="text-align: center;">Pro</th>
                                <th style="text-align: center;">Premium</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Nombre de salons</td>
                                <td style="text-align: center;">1</td>
                                <td style="text-align: center;">2</td>
                                <td style="text-align: center;">3+</td>
                            </tr>
                            <tr>
                                <td>Coiffeurs & Réservations</td>
                                <td style="text-align: center;">Illimités</td>
                                <td style="text-align: center;">Illimités</td>
                                <td style="text-align: center;">Illimités</td>
                            </tr>
                            <tr>
                                <td>Statistiques Avancées</td>
                                <td style="text-align: center;"><i class="fa-solid fa-xmark cross"></i></td>
                                <td style="text-align: center;"><i class="fa-solid fa-check check"></i></td>
                                <td style="text-align: center;"><i class="fa-solid fa-check check"></i></td>
                            </tr>
                            <tr>
                                <td>Personnalisation</td>
                                <td style="text-align: center;"><i class="fa-solid fa-xmark cross"></i></td>
                                <td style="text-align: center;"><i class="fa-solid fa-check check"></i></td>
                                <td style="text-align: center;"><i class="fa-solid fa-check check"></i></td>
                            </tr>
                            <tr>
                                <td>API Access</td>
                                <td style="text-align: center;"><i class="fa-solid fa-xmark cross"></i></td>
                                <td style="text-align: center;"><i class="fa-solid fa-xmark cross"></i></td>
                                <td style="text-align: center;"><i class="fa-solid fa-check check"></i></td>
                            </tr>
                            <tr>
                                <td>Support</td>
                                <td style="text-align: center;">Email</td>
                                <td style="text-align: center;">Prioritaire</td>
                                <td style="text-align: center;"><strong>VIP 24/7</strong></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>

    <script>
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }

        const stripe = Stripe('pk_test_51QO7j0GzX8q3q3q3q3q3q3q3q3q3q3q3q3q3q3q3q3q3q3q3q3q3q3q3q3q3q3q3q3q3q3q3q3q3q3q3q3q3q3q3'); // Placeholder

        document.addEventListener('DOMContentLoaded', fetchSubscriptionStatus);

        function getUsername() {
            const userStr = localStorage.getItem('user');
            const adminLoggedIn = sessionStorage.getItem('admin_logged_in') === 'true';
            
            if (userStr) {
                return JSON.parse(userStr).username;
            } else if (adminLoggedIn) {
                return sessionStorage.getItem('admin_name');
            }
            return null;
        }

        async function fetchSubscriptionStatus() {
            try {
                const username = getUsername();
                if (!username) return;

                const response = await fetch(`/api/api-subscription-status?username=${username}`);
                const data = await response.json();

                if (data.active && data.plan) {
                    const planName = data.plan.name.toLowerCase(); // 'starter', 'pro', 'premium'
                    markPlanAsActive(planName);
                }
            } catch (e) {
                console.error('Error fetching subscription:', e);
            }
        }

        function markPlanAsActive(plan) {
            const btn = document.getElementById(`btn-${plan}`);
            const card = document.getElementById(`card-${plan}`);
            
            if (btn) {
                btn.textContent = 'Plan Actuel';
                btn.disabled = true;
                btn.classList.remove('btn-primary', 'btn-white', 'btn-outline');
                btn.classList.add('btn-disabled');
                btn.removeAttribute('onclick');
            }

            // Handle badges
            const defaultBadge = card.querySelector('.plan-badge:not(.badge-current)');
            if (defaultBadge) defaultBadge.style.display = 'none';

            let currentBadge = card.querySelector('.badge-current');
            if (!currentBadge) {
                currentBadge = document.createElement('div');
                currentBadge.className = 'plan-badge badge-current';
                currentBadge.textContent = 'Actuel';
                card.insertBefore(currentBadge, card.firstChild);
            }
            currentBadge.style.display = 'block';
        }

        async function checkout(plan) {
            const username = getUsername();

            if (!username) {
                alert('Veuillez vous connecter pour souscrire à un plan.');
                return;
            }

            let email = 'client@example.com'; // Default
            const userStr = localStorage.getItem('user');
            if (userStr) {
                const u = JSON.parse(userStr);
                if (u.email) email = u.email;
            }
            
            try {
                const response = await fetch('/api/api-create-checkout-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        plan: plan,
                        email: email,
                        salonName: 'Salon Chic',
                        username: username
                    }),
                });

                const session = await response.json();

                if (session.error) {
                    alert(session.error);
                    return;
                }

                if (session.url) {
                    window.location.href = session.url;
                } else {
                    const result = await stripe.redirectToCheckout({
                        sessionId: session.sessionId,
                    });
    
                    if (result.error) {
                        alert(result.error.message);
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Une erreur est survenue.');
            }
        }
    </script>
</body>
</html>
