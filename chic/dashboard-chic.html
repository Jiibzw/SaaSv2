<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Salon Chic</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #c9184a;
            --primary-light: #c9184a15;
            --primary-hover: #c9184add;
            --bg: #f8fafc;
            --surface: #ffffff;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 16px;
            --sidebar-width: 280px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--bg); color: var(--text-main); -webkit-font-smoothing: antialiased; }
        
        /* Layout */
        .dashboard-container { display: flex; min-height: 100vh; }
        
        /* Sidebar */
        .sidebar { width: var(--sidebar-width); background: var(--surface); border-right: 1px solid var(--border); position: fixed; top: 0; bottom: 0; left: 0; z-index: 50; padding: 2rem 1.5rem; display: flex; flex-direction: column; transition: transform 0.3s ease; }
        .brand { display: flex; align-items: center; gap: 1rem; font-size: 1.25rem; font-weight: 700; color: var(--text-main); text-decoration: none; margin-bottom: 3rem; padding: 0 0.5rem; }
        .brand i { color: var(--primary); }
        .nav-menu { flex: 1; display: flex; flex-direction: column; gap: 0.5rem; }
        .nav-item { display: flex; align-items: center; gap: 1rem; padding: 1rem; color: var(--text-muted); text-decoration: none; border-radius: var(--radius); font-weight: 500; transition: all 0.2s; cursor: pointer; }
        .nav-item:hover { background: var(--bg); color: var(--text-main); }
        .nav-item.active { background: var(--primary-light); color: var(--primary); font-weight: 600; }
        .nav-item i { width: 20px; text-align: center; }
        
        .user-profile { margin-top: auto; padding-top: 1.5rem; border-top: 1px solid var(--border); display: flex; align-items: center; gap: 1rem; }
        .avatar { width: 40px; height: 40px; background: var(--primary); color: white; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: 600; }
        .user-info { flex: 1; overflow: hidden; }
        .user-name { font-weight: 600; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .user-role { font-size: 0.8rem; color: var(--text-muted); }
        .btn-logout { background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 0.5rem; border-radius: 8px; transition: all 0.2s; }
        .btn-logout:hover { background: #fee2e2; color: #ef4444; }

        /* Main Content */
        .main-content { flex: 1; margin-left: var(--sidebar-width); padding: 2rem; width: calc(100% - var(--sidebar-width)); }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2.5rem; }
        .page-title { font-size: 1.75rem; font-weight: 700; color: var(--text-main); }
        .date-display { color: var(--text-muted); font-weight: 500; }
        
        /* Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1.5rem; margin-bottom: 2.5rem; }
        .stat-card { background: var(--surface); padding: 1.5rem; border-radius: 20px; border: 1px solid var(--border); box-shadow: var(--shadow-sm); display: flex; align-items: center; gap: 1.5rem; transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .stat-icon { width: 56px; height: 56px; border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; flex-shrink: 0; }
        .stat-info { flex: 1; }
        .stat-value { font-size: 1.75rem; font-weight: 700; color: var(--text-main); line-height: 1.2; }
        .stat-label { color: var(--text-muted); font-size: 0.9rem; font-weight: 500; }
        
        /* Cards & Sections */
        .content-card { background: var(--surface); border-radius: 24px; border: 1px solid var(--border); box-shadow: var(--shadow-sm); overflow: hidden; margin-bottom: 2rem; padding: 2rem; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border); }
        .section-title { font-size: 1.25rem; font-weight: 700; display: flex; align-items: center; gap: 0.75rem; }
        
        /* Subscription Info */
        .subscription-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .info-box { background: var(--bg); padding: 1.25rem; border-radius: 16px; border: 1px solid var(--border); }
        .info-label { color: var(--text-muted); font-size: 0.85rem; font-weight: 600; text-transform: uppercase; margin-bottom: 0.5rem; }
        .info-value { font-size: 1.1rem; font-weight: 700; color: var(--text-main); }
        
        /* Tables */
        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        th { background: var(--bg); padding: 1rem 1.5rem; text-align: left; font-weight: 600; color: var(--text-muted); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid var(--border); }
        td { padding: 1.25rem 1.5rem; border-bottom: 1px solid var(--border); color: var(--text-main); font-size: 0.95rem; }
        tr:last-child td { border-bottom: none; }
        
        /* Badges & Buttons */
        .badge { padding: 0.35rem 0.85rem; border-radius: 99px; font-size: 0.8rem; font-weight: 600; display: inline-flex; align-items: center; gap: 0.35rem; }
        .badge-active { background: #f0fdf4; color: #15803d; border: 1px solid #dcfce7; }
        .badge-trial { background: #fffbeb; color: #b45309; border: 1px solid #fef3c7; }
        .badge-inactive { background: #fef2f2; color: #991b1b; border: 1px solid #fee2e2; }
        
        .btn { padding: 0.75rem 1.5rem; border-radius: 12px; font-weight: 600; cursor: pointer; border: none; transition: all 0.2s; display: inline-flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; text-decoration: none; }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 12px var(--primary-light); }
        .btn-primary:hover { background: var(--primary-hover); transform: translateY(-1px); }
        .btn-secondary { background: var(--bg); color: var(--text-main); border: 1px solid var(--border); }
        .btn-secondary:hover { background: #e2e8f0; }
        .btn-danger { background: #fee2e2; color: #dc2626; }
        .btn-danger:hover { background: #fecaca; }
        
        /* Payment Card */
        .payment-card { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); color: white; padding: 2rem; border-radius: 20px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); }
        .card-details { display: flex; align-items: center; gap: 1.5rem; }
        .card-icon { font-size: 2.5rem; opacity: 0.8; }
        .card-text strong { display: block; font-size: 1.1rem; margin-bottom: 0.25rem; }
        .card-text span { opacity: 0.7; font-size: 0.9rem; }
        .card-actions { display: flex; gap: 0.75rem; }
        .btn-card { background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; transition: all 0.2s; }
        .btn-card:hover { background: rgba(255,255,255,0.2); }
        
        .add-card-btn { width: 100%; padding: 1.5rem; background: var(--bg); border: 2px dashed var(--border); border-radius: 16px; color: var(--text-muted); font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 0.75rem; }
        .add-card-btn:hover { border-color: var(--primary); color: var(--primary); background: var(--primary-light); }
        
        /* Forms */
        .form-group { margin-bottom: 1.5rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-main); font-size: 0.9rem; }
        input { width: 100%; padding: 0.875rem 1rem; border: 1px solid var(--border); border-radius: 12px; font-family: inherit; transition: all 0.2s; background: var(--bg); }
        input:focus { outline: none; border-color: var(--primary); background: var(--surface); box-shadow: 0 0 0 4px var(--primary-light); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        
        /* Modal */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 100; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal.active { display: flex; }
        .modal-content { background: var(--surface); padding: 2rem; border-radius: 24px; width: 90%; max-width: 500px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted); }
        
        /* Mobile */
        .mobile-toggle { display: none; font-size: 1.5rem; color: var(--text-main); cursor: pointer; background: none; border: none; }
        
        @media (max-width: 1024px) {
            .sidebar { transform: translateX(-100%); box-shadow: 20px 0 40px rgba(0,0,0,0.1); }
            .sidebar.open { transform: translateX(0); }
            .main-content { margin-left: 0; width: 100%; padding: 1.5rem; }
            .mobile-toggle { display: block; }
            .top-bar { gap: 1rem; }
            .payment-card { flex-direction: column; gap: 1.5rem; text-align: center; }
            .card-details { flex-direction: column; gap: 1rem; }
        }
    </style>
</head>
<body>

    <div class="dashboard-container">
        <aside class="sidebar" id="sidebar">
            <a href="#" class="brand"><i class="fa-solid fa-clock"></i> TimeToBook</a>
            <nav class="nav-menu">
                <div class="nav-item active"><i class="fa-solid fa-chart-pie"></i> Vue d'ensemble</div>
                <a href="admin.html" class="nav-item"><i class="fa-solid fa-store"></i> Gestion Salon</a>
                <a href="pricing-salon.html" class="nav-item"><i class="fa-solid fa-tags"></i> Offres & Tarifs</a>
            </nav>
            <div class="user-profile">
                <div class="avatar">{SALON_ID[0].toUpperCase()}</div>
                <div class="user-info">
                    <div class="user-name">Salon Chic</div>
                    <div class="user-role">Propriétaire</div>
                </div>
                <a href="../" class="btn-logout" title="Déconnexion"><i class="fa-solid fa-right-from-bracket"></i></a>
            </div>
        </aside>

        <main class="main-content">
            <div class="top-bar">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <button class="mobile-toggle" onclick="toggleSidebar()"><i class="fa-solid fa-bars"></i></button>
                    <div>
                        <h1 class="page-title">Mon Abonnement</h1>
                        <div class="date-display">Gérez votre souscription et vos factures</div>
                    </div>
                </div>
            </div>

            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon" style="background: #ecfdf5; color: #059669;"><i class="fa-solid fa-calendar-check"></i></div>
                    <div class="stat-info"><div class="stat-label">Réservations (Mois)</div><div class="stat-value">47</div></div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: #eff6ff; color: #3b82f6;"><i class="fa-solid fa-users"></i></div>
                    <div class="stat-info"><div class="stat-label">Coiffeurs Actifs</div><div class="stat-value">3</div></div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: #f5f3ff; color: #8b5cf6;"><i class="fa-solid fa-chart-line"></i></div>
                    <div class="stat-info"><div class="stat-label">Total Réservations</div><div class="stat-value">127</div></div>
                </div>
            </div>

            <!-- Subscription -->
            <div class="content-card">
                <div class="section-header">
                    <div class="section-title"><i class="fa-solid fa-credit-card" style="color: var(--primary);"></i> Détails de l'abonnement</div>
                    <span id="subscription-status-badge" class="badge badge-active">Chargement...</span>
                </div>
                
                <div class="subscription-grid">
                    <div class="info-box"><div class="info-label">Plan Actuel</div><div class="info-value" id="plan-name">...</div></div>
                    <div class="info-box"><div class="info-label">Prix</div><div class="info-value" id="plan-price">...</div></div>
                    <div class="info-box"><div class="info-label">Prochain Paiement</div><div class="info-value" id="next-payment">...</div></div>
                    <div class="info-box"><div class="info-label">Essai Gratuit</div><div class="info-value" id="trial-info" style="color: #b45309;">...</div></div>
                </div>

                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                    <a href="pricing-salon.html" class="btn btn-primary">Changer de plan</a>
                    <button class="btn btn-danger" onclick="cancelSubscription()">Résilier l'abonnement</button>
                </div>
            </div>

            <!-- Payment Methods -->
            <div class="content-card">
                <div class="section-header">
                    <div class="section-title"><i class="fa-solid fa-wallet" style="color: var(--primary);"></i> Moyens de paiement</div>
                </div>
                
                <div id="payment-card-container" class="payment-card" style="display: none;">
                    <div class="card-details">
                        <div class="card-icon" id="card-brand-icon"><i class="fa-brands fa-cc-visa"></i></div>
                        <div class="card-text">
                            <strong id="card-last4">•••• •••• •••• 4242</strong>
                            <span id="card-exp">Expire 12/2027</span>
                        </div>
                    </div>
                    <div class="card-actions">
                        <button class="btn-card" onclick="openEditCardModal()">Modifier</button>
                        <button class="btn-card" onclick="deleteCard()" style="background: rgba(220, 38, 38, 0.2); border-color: rgba(220, 38, 38, 0.3); color: #fca5a5;">Supprimer</button>
                    </div>
                </div>

                <div id="no-payment-method" style="display: none; text-align: center; padding: 2rem; color: var(--text-muted);">
                    Aucun moyen de paiement enregistré.
                </div>

                <button class="add-card-btn" onclick="openAddCardModal()">
                    <i class="fa-solid fa-plus"></i> Ajouter une carte bancaire
                </button>
            </div>

            <!-- Invoices -->
            <div class="content-card">
                <div class="section-header">
                    <div class="section-title"><i class="fa-solid fa-file-invoice" style="color: var(--primary);"></i> Historique de facturation</div>
                </div>
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr><th>Date</th><th>Montant</th><th>Statut</th><th>Action</th></tr>
                        </thead>
                        <tbody id="invoices-table-body">
                            <tr><td colspan="4" style="text-align: center;">Chargement...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="addCardModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="font-size: 1.25rem; font-weight: 700;">Ajouter une carte</h3>
                <button class="close-btn" onclick="closeAddCardModal()">×</button>
            </div>
            <form onsubmit="addCard(event)">
                <div class="form-group"><label>Numéro de carte</label><input type="text" placeholder="0000 0000 0000 0000" maxlength="19" required></div>
                <div class="form-group"><label>Nom sur la carte</label><input type="text" placeholder="JEAN DUPONT" required></div>
                <div class="form-row">
                    <div class="form-group"><label>Expiration</label><input type="text" placeholder="MM/AA" maxlength="5" required></div>
                    <div class="form-group"><label>CVC</label><input type="text" placeholder="123" maxlength="3" required></div>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; justify-content: center; margin-top: 1rem;">Enregistrer la carte</button>
            </form>
        </div>
    </div>

    <div id="editCardModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="font-size: 1.25rem; font-weight: 700;">Modifier la carte</h3>
                <button class="close-btn" onclick="closeEditCardModal()">×</button>
            </div>
            <form onsubmit="updateCard(event)">
                <div class="form-group"><label>Numéro de carte</label><input type="text" value="•••• •••• •••• 4242" disabled style="background: #f1f5f9;"></div>
                <div class="form-group"><label>Nom sur la carte</label><input type="text" value="JEAN DUPONT" required></div>
                <div class="form-row">
                    <div class="form-group"><label>Expiration</label><input type="text" placeholder="12/27" maxlength="5" required></div>
                    <div class="form-group"><label>CVC</label><input type="text" placeholder="123" maxlength="3" required></div>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; justify-content: center; margin-top: 1rem;">Mettre à jour</button>
            </form>
        </div>
    </div>

    <script>
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
        
        function openAddCardModal() { document.getElementById('addCardModal').classList.add('active'); }
        function closeAddCardModal() { document.getElementById('addCardModal').classList.remove('active'); }
        
        function openEditCardModal() { document.getElementById('editCardModal').classList.add('active'); }
        function closeEditCardModal() { document.getElementById('editCardModal').classList.remove('active'); }
        
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        }

        function addCard(event) {
            event.preventDefault();
            alert('✅ Carte ajoutée avec succès!');
            closeAddCardModal();
        }

        function updateCard(event) {
            event.preventDefault();
            alert('✅ Carte mise à jour avec succès!');
            closeEditCardModal();
        }

        function deleteCard() {
            if (confirm('⚠️ Êtes-vous sûr de vouloir supprimer cette carte ?')) {
                alert('✅ Carte supprimée avec succès!');
            }
        }

        function cancelSubscription() {
            if (confirm('⚠️ Êtes-vous sûr de vouloir résilier votre abonnement ?')) {
                alert('✅ Résiliation confirmée. Votre accès reste actif jusqu\\'au 14 décembre 2025.');
            }
        }

        // Fetch Subscription Data
        document.addEventListener('DOMContentLoaded', async () => {
            const userStr = localStorage.getItem('user');
            if (!userStr) {
                window.location.href = '../index.html';
                return;
            }
            const user = JSON.parse(userStr);
            
            try {
                const response = await fetch(`/api/api-subscription-status?username=${user.username}`);
                const data = await response.json();

                if (data.error) {
                    console.error(data.error);
                    return;
                }

                // Update Status
                const statusBadge = document.getElementById('subscription-status-badge');
                statusBadge.textContent = data.status.toUpperCase();
                if (data.status === 'active') {
                    statusBadge.className = 'badge badge-active';
                } else {
                    statusBadge.className = 'badge badge-inactive';
                }

                // Update Plan Info
                document.getElementById('plan-name').textContent = data.plan.name;
                document.getElementById('plan-price').textContent = `${data.plan.price}€ / ${data.plan.interval}`;
                
                if (data.current_period_end) {
                    const date = new Date(data.current_period_end);
                    document.getElementById('next-payment').textContent = date.toLocaleDateString('fr-FR');
                } else {
                    document.getElementById('next-payment').textContent = '-';
                }

                if (data.trial_end) {
                    const trialDate = new Date(data.trial_end);
                    const now = new Date();
                    const diffTime = Math.abs(trialDate - now);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                    document.getElementById('trial-info').textContent = `Reste ${diffDays} jours`;
                } else {
                    document.getElementById('trial-info').textContent = 'Terminé';
                    document.getElementById('trial-info').style.color = 'var(--text-muted)';
                }

                // Update Payment Method
                if (data.payment_method) {
                    document.getElementById('payment-card-container').style.display = 'flex';
                    document.getElementById('no-payment-method').style.display = 'none';
                    document.getElementById('card-last4').textContent = `•••• •••• •••• ${data.payment_method.last4}`;
                    document.getElementById('card-exp').textContent = `Expire ${data.payment_method.exp_month}/${data.payment_method.exp_year}`;
                    
                    const brandIcon = document.getElementById('card-brand-icon');
                    brandIcon.innerHTML = `<i class="fa-brands fa-cc-${data.payment_method.brand.toLowerCase()}"></i>`;
                } else {
                    document.getElementById('payment-card-container').style.display = 'none';
                    document.getElementById('no-payment-method').style.display = 'block';
                }

                // Update Invoices
                const tbody = document.getElementById('invoices-table-body');
                tbody.innerHTML = '';
                if (data.invoices && data.invoices.length > 0) {
                    data.invoices.forEach(inv => {
                        const row = document.createElement('tr');
                        const date = new Date(inv.date).toLocaleDateString('fr-FR');
                        row.innerHTML = `
                            <td>${date}</td>
                            <td><strong>${inv.amount}€</strong></td>
                            <td><span class="badge badge-active">${inv.status}</span></td>
                            <td><a href="${inv.pdf}" target="_blank" class="btn-card" style="color: var(--primary); border-color: var(--border); background: white;">PDF</a></td>
                        `;
                        tbody.appendChild(row);
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">Aucune facture trouvée</td></tr>';
                }

            } catch (error) {
                console.error('Error fetching subscription:', error);
            }
        });
    </script>
</body>
</html>
